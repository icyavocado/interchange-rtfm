<!doctype html public "-//W30//DTD W3 HTML 2.0//EN">

<HTML>

<!-- This file was generated using SDF 2.001 by
     Ian Clatworthy (ianc@mincom.com). SDF is freely
     available from http://www.mincom.com/mtr/sdf. -->

<HEAD>
<TITLE>Interchange Ecommerce Functions</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="docs.css">
</HEAD>
<BODY BGCOLOR="ffffff" LINK="993333">

<DIV CLASS="header">
<DIV CLASS="navigate">
<P ALIGN="Center"><A HREF="index.html" TARGET="_top">Documentation Index</A></P>
</DIV>
</DIV>
<DIV CLASS="title">
<P><IMG SRC="iclogo2002.gif" ALIGN="Right"></P>
<H1 CLASS="doc-title">Interchange Ecommerce Functions</H1>
<ADDRESS CLASS="doc-author"></ADDRESS>
<BR CLEAR="All">
</DIV>
<DIV CLASS="contents">
<HR>
<H2>Table of Contents</H2>
<UL>
<A HREF="#THE ORDER PROCESS">1. THE ORDER PROCESS</A><UL>
<A HREF="#How to order an item">1.1. How to order an item</A>
<BR>
<A HREF="#How to set up an order link">1.2. How to set up an order link</A>
<BR>
<A HREF="#How to set up an order button">1.3. How to set up an order button</A>
<BR>
<A HREF="#How to set up an on-the-fly item">1.4. How to set up an on-the-fly item</A>
<BR>
<A HREF="#Order Groups">1.5. Order Groups</A>
<BR>
<A HREF="#Basket display">1.6. Basket display</A>
<BR>
<A HREF="#Multiple Shopping Carts">1.7. Multiple Shopping Carts</A></UL>
<BR>
<A HREF="#PRODUCT PRICING">2. PRODUCT PRICING</A><UL>
<A HREF="#Simple pricing">2.1. Simple pricing</A>
<BR>
<A HREF="#Price Maintenance with CommonAdjust">2.2. Price Maintenance with CommonAdjust</A>
<BR>
<A HREF="#CommonAdjust Examples">2.3. CommonAdjust Examples</A>
<BR>
<A HREF="#PriceBreaks, discounts, and PriceAdjustment">2.4. PriceBreaks, discounts, and PriceAdjustment</A>
<BR>
<A HREF="#Item Attributes">2.5. Item Attributes</A>
<BR>
<A HREF="#Product Discounts">2.6. Product Discounts</A></UL>
<BR>
<A HREF="#Taxing">3. Taxing</A><UL>
<A HREF="#Sales Tax -- simple salestax.asc table">3.1. Sales Tax -- simple salestax.asc table</A>
<BR>
<A HREF="#Fly tax">3.2. Fly tax</A>
<BR>
<A HREF="#Salestax &quot;multi&quot; -- VAT taxing">3.3. Salestax &quot;multi&quot; -- VAT taxing</A></UL>
<BR>
<A HREF="#THE CHECKOUT PROCESS">4. THE CHECKOUT PROCESS</A><UL>
<A HREF="#Advanced Multi-level Order Pages">4.1. Advanced Multi-level Order Pages</A>
<BR>
<A HREF="#Simple Order Report File">4.2. Simple Order Report File</A>
<BR>
<A HREF="#Fully-configurable Order Reports">4.3. Fully-configurable Order Reports</A>
<BR>
<A HREF="#Order Receipts">4.4. Order Receipts</A>
<BR>
<A HREF="#The Order Counter">4.5. The Order Counter</A>
<BR>
<A HREF="#Customer Input Fields">4.6. Customer Input Fields</A></UL></UL>
</DIV>
<DIV CLASS="main">
<HR>
<H1><A NAME="THE ORDER PROCESS">1. THE ORDER PROCESS</A></H1>
<P>Interchange has a completely flexible order basket and checkout scheme. The <TT>foundation</TT> demo presents a common use of this process, in the directory pages/ord -- the files are:</P>
<PRE>
    basket.html      The order basket displayed by default
    checkout.html    The form where the customer enters their billing
                     and shipping info
</PRE>
<UL><UL><UL>
and in the directory etc:</UL></UL></UL>
<PRE>
    receipt.html     The receipt displayed to the customer
    report           The order report mailed to you
    mail_receipt     The customer's email copy (if requested)
</PRE>
<P>It is not strictly necessary to display an order basket when an item is ordered. If you specify a different page to be displayed that is fine, but most customers will be confused if you don't give them an indication that the order operation has succeeded.</P>
<P>Any order basket is an HTML <TT>FORM</TT>. It will have a number of variables on it. At the minimum it must have an <TT>[item-list]</TT> to loop through the items, and the <TT>quantity</TT> of each item must be set in some place on that form. Any valid Interchange tags may be used on the page, and you may use multiple item lists if necessary.</P>
<H2><A NAME="How to order an item">1.1. How to order an item</A></H2>
<P>Interchange can either use a form-based order or a link-based order to place an item in the shopping cart. The link-based order uses the special <TT>[order item-code]</TT> tag:</P>
<P><B>[order code]</B></P>
<UL>
named attributes:</UL>
<PRE>
            [order code=&quot;sku&quot; quantity=&quot;n&quot;* href=&quot;page&quot;* cart=&quot;cartname&quot;* base=&quot;table&quot;*]
            * = optional parameters
</PRE>
<UL>
Expands into a hypertext link which will include the specified code in the list of products to order and display the order page. <B>code</B> should be a product SKU listed in one of the &quot;products&quot; tables, and is the only required parameter. <B>quantity</B> may be specified if more than one (the default) of the item should be placed in the cart. <B>href</B> allows some page other than the default order page to be displayed once the item has been added to the cart. <B>cart</B> selects the shopping cart the item will be placed in. The optional argument <B>base</B> constrains the order to a particular products file -- if not specified, all tables defined as products files will be searched in sequence for the item.
<BR>

<BR>
Example:</UL>
<PRE>
      Order a [order TK112]Toaster&lt;/a&gt; today.
</PRE>
<UL>
Note that this is the same as:</UL>
<PRE>
      Order a [page order TK112]Toaster&lt;/A&gt; today.
</PRE>
<UL>
You can change frames for the order with:</UL>
<PRE>
      Order a &lt;A HREF=&quot;[area order TK112]&quot; TARGET=newframe&gt;Toaster&lt;/A&gt; today.
</PRE>
<P><B>[/order]</B></P>
<UL>
Expands into &lt;/a&gt;. May be used to give the order tag the appearance of being a container tag, but neither necessary nor recommended.</UL>
<P>To order with a form, you set the form variable <TT>mv_order_item</TT> to the item-code/SKU and use the <TT>refresh</TT> action:</P>
<PRE>
  &lt;FORM ACTION=&quot;[process-target]&quot; METHOD=POST&gt;
  &lt;INPUT TYPE=hidden  NAME=&quot;mv_todo&quot;        VALUE=&quot;refresh&quot;&gt;
  &lt;INPUT TYPE=hidden  NAME=&quot;mv_order_item&quot;  VALUE=&quot;TK112&quot;&gt;

  Order &lt;INPUT NAME=&quot;mv_order_quantity&quot; SIZE=3 VALUE=1&gt; toaster

  &lt;INPUT TYPE=submit VALUE=&quot;Order!&quot;&gt;
  &lt;/FORM&gt;
</PRE>
<P>You may batch select whole groups of items:</P>
<PRE>
  &lt;FORM ACTION=&quot;[process-target]&quot; METHOD=POST&gt;
  &lt;INPUT TYPE=hidden  NAME=&quot;mv_todo&quot;        VALUE=&quot;refresh&quot;&gt;

  &lt;INPUT TYPE=hidden  NAME=&quot;mv_order_item&quot;  VALUE=&quot;TK112&quot;&gt;
  &lt;INPUT NAME=&quot;mv_order_quantity&quot; SIZE=3&gt; Standard Toaster

  &lt;INPUT TYPE=hidden  NAME=&quot;mv_order_item&quot;  VALUE=&quot;TK200&quot;&gt;
  &lt;INPUT NAME=&quot;mv_order_quantity&quot; SIZE=3&gt; Super Toaster

  &lt;INPUT TYPE=submit VALUE=&quot;Order!&quot;&gt;
  &lt;/FORM&gt;
</PRE>
<P>Items that have a quantity of zero (or blank) will be skipped, and only items with a positive quantity will be placed in the basket.</P>
<P>You may also specify attributes like size or color at time of order (see <I>How to set up an order button</I>).</P>
<H2><A NAME="How to set up an order link">1.2. How to set up an order link</A></H2>
<P>On a product display page, use:</P>
<PRE>
    [order 00-0011]Order the Mona Lisa&lt;/a&gt;
</PRE>
<P>If coming from a search results or on-the-fly page, you may use the generated <TT>[item-code]</TT> thusly:</P>
<PRE>
    [order [item-code]]Order [item-field name]&lt;/a&gt;
</PRE>
<P>Bear in mind that if you have not reached the page via a search or on-the-fly operation, <TT>[item-code]</TT> means nothing and will cause an error.</P>
<H2><A NAME="How to set up an order button">1.3. How to set up an order button</A></H2>
<P>Interchange can order via form submission as well. This allows you to order a product (or group of products) via a form button. In its simplest form, it is:</P>
<PRE>
    &lt;FORM ACTION=&quot;[process-target]&quot; METHOD=POST&gt;
    &lt;INPUT TYPE=hidden NAME=mv_todo VALUE=refresh&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;00-0011&quot;&gt;
    &lt;INPUT TYPE=submit VALUE=&quot;Order the Mona Lisa&quot;&gt;
    &lt;/FORM&gt;
</PRE>
<P>The default quantity is one.  An initial quantity may be set by the user by adding an mv_order_quantity variable:</P>
<PRE>
     Number to order:&lt;INPUT TYPE=text NAME=mv_order_quantity VALUE=&quot;1&quot;&gt;
</PRE>
<P>You can order multiple items by stacking the variables:</P>
<PRE>
    &lt;FORM ACTION=&quot;[process-target]&quot; METHOD=POST&gt;
    &lt;INPUT TYPE=hidden NAME=mv_todo VALUE=refresh&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;00-0011&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;00-0011a&quot;&gt;
    &lt;INPUT TYPE=submit VALUE=&quot;Order the Mona Lisa with frame&quot;&gt;
    &lt;/FORM&gt;
</PRE>
<P>Initial size or color may be set as well, provided <I>UseModifier</I> is set up properly:</P>
<PRE>
    &lt;INPUT TYPE=hidden NAME=mv_order_size VALUE=&quot;L&quot;&gt;
</PRE>
<P>If the order is coming from a generated flypage, loop list, or search results page, you can get a canned select box from the <TT>[item-accessories size]</TT> or <TT>[item-accessories size]</TT> tag. See <I>Item Attributes</I>.</P>
<H2><A NAME="How to set up an on-the-fly item">1.4. How to set up an on-the-fly item</A></H2>
<P>If you enable the catalog directive <I>OnFly</I>, setting it to the name of a subroutine (or possibly a UserTag) that can handle its calls, then Interchange will add items to the basket that are not in the product database. Interchange supplies an internal <TT>onfly</TT> subroutine, which will work according to the examples given below.</P>
<P>In <TT>catalog.cfg</TT>:</P>
<PRE>
    OnFly  onfly
</PRE>
<P>If your item code is not to be named <TT>mv_order_item</TT> then you must perform a rename in the <TT>Autoload</TT> routine.</P>
<P>A basic link can be generated like:</P>
<PRE>
    &lt;a href=&quot;[area form=&quot;
            mv_todo=refresh
            mv_order_item=000101
            mv_order_fly=description=An on-the-fly item|price=100.01
    &quot;]&quot;&gt;Order item 000101&lt;/a&gt;
</PRE>
<P>The form parameter value <TT>mv_order_fly</TT> can contain any number of fields which will set corresponding parameters in the item attributes. The fields are separated by the pipe (<TT>|</TT>) character and contain value-parameter pairs separated by an = sign. (These are URL-encoded by the <TT>[area ...]</TT> or <TT>[page ...]</TT> tag, of course.) You can set a size, color, or any other parameter.</P>
<P>The special attribute <TT>mv_price</TT> can be used in conjunction with the <TT>CommonAdjust</TT> atom <TT>$</TT> to set the price for checkout and display.</P>
<P>The <TT>[item-list]</TT> sub-tag <TT>[item-description]</TT>, when used with an item-list, will use the item attribute <TT>description</TT> to display in the basket. Note that <TT>[item-field description]</TT> or <TT>[item-data products description]</TT> will NOT work, as both of these tags reference an actual field value for a record in the products table - not applicable for on-the-fly items. Similarly, an attempt to generate a flypage for an on-the-fly item (<TT>[page 000101]</TT>, for example) will fail, resulting in the display of the SpecialPage <B>missing</B>.</P>
<P>If you wish to set up a UserTag to process on-the-fly items, it should accept a call of</P>
<PRE>
    usertag(mv_item_code, mv_item_quantity, mv_order_fly)
</PRE>
<P>The <TT>mv_item_code</TT> and <TT>mv_order_fly</TT> parameters are required to trigger Interchange's <TT>add_item</TT> routine (along with mv_todo=refresh to set the action).</P>
<P>The item will always act as if <TT>SeparateItems</TT> or <TT>mv_separate_items</TT> is set.</P>
<P>Multiple items can be ordered at once by stacking the variables. If there is only one <TT>mv_order_item</TT> instance, however, you can stack the <TT>mv_order_fly</TT> variable so that all are concatenated together as with the <TT>|</TT> symbol. So the above example could be done as:</P>
<PRE>
    [area form=&quot;
            mv_todo=refresh
            mv_order_item=000101
            mv_order_fly=description=An on-the-fly item
            mv_order_fly=price=100.00
    &quot;]
</PRE>
<P>Multiple items would need multiple instances of <TT>mv_order_item</TT> with a corresponding <TT>mv_order_fly</TT> for each <TT>mv_order_item</TT>. You can order both <TT>000101</TT> and <TT>000101</TT> as follows:</P>
<PRE>
    [area form=&quot;
        mv_todo=refresh

        mv_order_item=000101
        mv_order_fly=description=An on-the-fly item|price=100.00

        mv_order_item=000102
        mv_order_fly=description=Another on-the-fly item|price=200.00
    &quot;]
</PRE>
<P>The following two forms correspond to the above two examples, in order, with the slight refinement of adding a quantity:</P>
<PRE>
  &lt;FORM ACTION=&quot;[area process]&quot; METHOD=POST&gt;
        &lt;INPUT TYPE=hidden NAME=mv_todo VALUE=&quot;refresh&quot;&gt;
        &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;000101&quot;&gt;
        Qty: &lt;INPUT SIZE=2 NAME=mv_order_quantity VALUE=&quot;1&quot;&gt;
        &lt;INPUT TYPE=hidden NAME=mv_order_fly
                VALUE=&quot;description=An on-the-fly item|price=100.00&quot;&gt;
        &lt;INPUT TYPE=submit VALUE=&quot;Order button&quot;&gt;
    &lt;/FORM&gt;

   &lt;FORM ACTION=&quot;[area process]&quot; METHOD=POST&gt;
        &lt;INPUT TYPE=hidden NAME=mv_todo VALUE=&quot;refresh&quot;&gt;
        &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;000101&quot;&gt;
        Qty: &lt;INPUT SIZE=2 NAME=mv_order_quantity VALUE=&quot;1&quot;&gt;&lt;BR&gt;
        &lt;INPUT TYPE=hidden NAME=mv_order_fly
            VALUE=&quot;description=An on-the-fly item|price=100.00&quot;&gt;
        &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;000102&quot;&gt;
        Qty: &lt;INPUT SIZE=2 NAME=mv_order_quantity VALUE=&quot;1&quot;&gt;&lt;BR&gt;
        &lt;INPUT TYPE=hidden NAME=mv_order_fly
            VALUE=&quot;description=Another on-the-fly item|price=200.00&quot;&gt;
        &lt;INPUT TYPE=submit VALUE=&quot;Order two different with a button&quot;&gt;
    &lt;/FORM&gt;
</PRE>
<H2><A NAME="Order Groups">1.5. Order Groups</A></H2>
<P>Interchange allows you to group items together, making a master item and sub-items. This can be used to delete accessories or options when the master item is deleted. In its simplest form, you order just one master item and all subsequent items are sub-items.</P>
<PRE>
    &lt;FORM ACTION=&quot;[process-target]&quot; METHOD=POST&gt;
    &lt;INPUT TYPE=hidden NAME=mv_todo VALUE=refresh&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_group VALUE=&quot;1&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;00-0011&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;00-0011a&quot;&gt;
    &lt;INPUT TYPE=submit VALUE=&quot;Order the Mona Lisa with frame&quot;&gt;
    &lt;/FORM&gt;
</PRE>
<P>If you wish to stack more than one master item, then you must define mv_order_group for <B>all</B> items, with either a 1 value (master) or 0 value (sub-item). A master owns all subsequent sub-items until the next master is defined.</P>
<PRE>
    &lt;FORM ACTION=&quot;[process-target]&quot; METHOD=POST&gt;
    &lt;INPUT TYPE=hidden NAME=mv_todo VALUE=refresh&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_group VALUE=&quot;1&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;00-0011&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_group VALUE=&quot;0&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;00-0011a&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_group VALUE=&quot;1&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;19-202&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_group VALUE=&quot;0&quot;&gt;
    &lt;INPUT TYPE=hidden NAME=mv_order_item VALUE=&quot;99-102&quot;&gt;
    &lt;INPUT TYPE=submit VALUE=&quot;Order items&quot;&gt;
    &lt;/FORM&gt;
</PRE>
<P>When the master item <TT>00-0011</TT> is deleted from the basket, <TT>00-0011a</TT> will be deleted as well. And when 19-202 is deleted, then 99-102 will be deleted from the basket.</P>
<P>NOTE: Use of checkboxes for this type of thing can be hazardous, as they do not pass a value when unchecked.  It is preferable to use radio groups or select/drop-down widgets. If you must use checkboxes, be sure to explicitly clear <TT>mv_order_group</TT> and <TT>mv_order_item</TT> somewhere on the page which contains the form:</P>
<PRE>
    [value name=mv_order_group set='']
    [value name=mv_order_item set='']
</PRE>
<P>The attributes <TT>mv_mi</TT> and <TT>mv_si</TT> are set to the group and sub-item status of each item.  The group, contained in the attribute <TT>mv_mi</TT>, is a meaningless yet unique integer. All items in a group will have the same value of <TT>mv_mi</TT>. The attribute <TT>mv_si</TT> is set to 0 if the item is a master item, and 1 if it is a sub-item.</P>
<H2><A NAME="Basket display">1.6. Basket display</A></H2>
<P>The basket page(s) are where the items are tracked and adjusted by the customer. It is possible to have an unlimited number of basket pages. It is also possible to have multiple shopping carts, as in buy or sell. This allows a basket/checkout type of ordering scheme, with custom order pages for items which have many accessories.</P>
<P>The name of the page to display can be configured in several ways:</P>
<OL>
<LI>Set the SpecialPage <TT>order</TT> to the page to display when an item is ordered.
<LI>Use the <TT>[order code=item page=page_name] Order it! &lt;/a&gt;</TT> form of order tag to specify an arbitrary order page for an item.
<LI>If already on an order page, set the mv_orderpage, mv_nextpage, mv_successpage, or mv_failpage variables.</OL>
<P>The following variables can be used to control cart selection and page display:</P>
<P><B>mv_cartname</B></P>
<UL>
The shopping cart (default is main) to be used for this order operation.</UL>
<P><B>mv_failpage</B></P>
<UL>
Page to be displayed on a failed order check (see <I>Advanced Multi-level Order Pages</I>)</UL>
<P><B>mv_nextpage</B></P>
<UL>
Page to display on a return operation.</UL>
<P><B>mv_orderpage</B></P>
<UL>
Page to be displayed on a refresh.</UL>
<P><B>mv_successpage</B></P>
<UL>
Page to be displayed on a successful order check (see <I>Advanced Multi-level Order Pages</I>).</UL>
<P><B>mv_order_profile</B></P>
<UL>
Order profile to be used if the form action is <TT>submit</TT> (see <I>Advanced Multi-level Order Pages</I>).</UL>
<H2><A NAME="Multiple Shopping Carts">1.7. Multiple Shopping Carts</A></H2>
<P>Interchange allows you to define and maintain multiple shopping carts. One shopping cart -- main, by name -- is defined when the user session starts. If the user orders item M1212 with the following tag:</P>
<PRE>
    [order code=M1212 cart=layaway] Order this item! &lt;/a&gt;
</PRE>
<P>the order will be placed in the cart named <I>layaway</I>. However, by default you won't see the just-ordered item on the basket page.  That is because the default shopping basket displays the contents of the 'main' cart only. So copy the default basket page (pages/ord/basket.html in the demo) to a new file, insert a <TT>[cart layaway]</TT> tag, and specify it as the target page in your <TT>[order]</TT> tag:</P>
<PRE>
    [order code=M1212 cart=layaway page=ord/lay_basket] Order this item! &lt;/a&gt;
</PRE>
<P>Now the contents of the <I>layaway</I> cart will be displayed. Most of the ITL tags that are fundamental to cart display accept a 'cartname' option, allowing you to specify which cart to be used:</P>
<P><B>[cart cartname]</B></P>
<UL>
A 'sticky' setting of the default cart name to use for all subsequent cart-related tags.  Convenient, but you must remember to use <TT>[cart main]</TT> to get back to the primary cart!  As an alternative, you can specify the desired cart as a parameter of the other tags.  These are not sticky, referencing the specified cart only for the instance in which they are called:</UL>
<P><B>[item-list cartname]...[/item-list]</B></P>
<UL>
Iterates over the items in the specified cart - tags like <TT>[item-quantity]</TT> and <TT>[item-price]</TT> will be evaluated accordingly;</UL>
<P><B>[nitems cartname]</B></P>
<UL>
Returns the total number of items in the specified cart;</UL>
<P><B>[subtotal cartname]</B></P>
<UL>
Returns the monetary subtotal for the contents of specified cart;</UL>
<P><B>[shipping cartname], [handling cartname], [salestax cartname], [total-cost cartname]</B></P>
<UL>
You get the idea. It is worth noting that tags which summarize cart contents do not need to be in used concert, or in conjunction with an <TT>[item-list]</TT>. For instance, you can display just the grand total for a cart on the sidebar or bottom of each page, using <TT>[total-cost]</TT> by itself, if you wish.</UL>
<P>You can also order items from a form, using the <TT>mv_order_item</TT>, <TT>mv_cartname</TT>, and optional <TT>mv_order_quantity</TT> variables.</P>
<PRE>
 &lt;FORM METHOD=POST ACTION=&quot;[process]&quot;&gt;
 &lt;input type=checkbox name=&quot;mv_order_item&quot; value=&quot;M3243&quot;&gt; Item M3243
 &lt;input name=&quot;mv_order_quantity&quot; value=&quot;1&quot;&gt; Quantity
 &lt;input type=hidden name=&quot;mv_cartname&quot; value=&quot;layaway&quot;&gt;
 &lt;input type=hidden name=&quot;mv_doit&quot; value=&quot;refresh&quot;&gt;
 &lt;input type=submit name=&quot;mv_junk&quot; value=&quot;Place on Layaway Now!&quot;&gt;
 &lt;/FORM&gt;
</PRE>
<P>If you need to utilize an alternative item price in conjunction with the use of a custom cart, see the section on <I>PRODUCT PRICING</I> for pricing methods and strategies.</P>
<HR>
<H1><A NAME="PRODUCT PRICING">2. PRODUCT PRICING</A></H1>
<P>Interchange maintains a price in its database for every product. The price field is the one required field in the product database -- it is necessary to build the price routines.</P>
<P>For speed, Interchange builds the code that is used to determine a product's price at catalog configuration time. If you choose to change a directive that affects product pricing you must reconfigure the catalog.</P>
<H2><A NAME="Simple pricing">2.1. Simple pricing</A></H2>
<P>The simplest method is flat pricing based on a fixed value in the <TT>products</TT> database. If you put that price in a field named <TT>price</TT>, you don't need to do more. If you want to change pricing based on quantity, size, color or other factors read on.</P>
<H2><A NAME="Price Maintenance with CommonAdjust">2.2. Price Maintenance with CommonAdjust</A></H2>
<P>A flexible chained pricing scheme is available when the <I>CommonAdjust</I> directive is set.</P>
<P>NOTE: For compatibility with older carts, if both PriceAdjustment and CommonAdjust are set, and CommonAdjust contains a valid database identifier, the CommonAdjust value is used to set pricing adjustments based on item attributes. This is not discussed further in this section; all items below assume <I>PriceAdjustment</I> is not in use.</P>
<P>We talk below about a <I>CommonAdjust string</I>; it will be defined in due time.</P>
<P>A few rules about CommonAdjust, all assuming the <I>PriceField</I> directive is set to <TT>price</TT>:</P>
<P><B>1</B></P>
<UL>
If <TT>CommonAdjust</TT> is set to any value, a valid <I>CommonAdjust string</I> or not, extended price adjustments are enabled. It may also hold the default pricing scheme.</UL>
<P><B>2</B></P>
<UL>
The <TT>price</TT> field may also hold a <I>CommonAdjust string</I>. It takes precedence over the default.</UL>
<P><B>3</B></P>
<UL>
If the value of the <TT>CommonAdjust</TT> directive is set to a CommonAdjust string, and the <TT>price</TT> field is empty or specifically <I>0</I>, then it will be used to set the price of the items.</UL>
<P><B>4</B></P>
<UL>
If PriceBreaks is in use, its price will take precedence over the value of <TT>CommonAdjust</TT>, though it may also contain a CommonAdjust string.</UL>
<P><B>5</B></P>
<UL>
If no CommonAdjust strings are found, then the price will be 0, subject to any later application of discounts.</UL>
<P><B>6</B></P>
<UL>
If another CommonAdjust string is found as the result of an operation, it will be re-parsed and the result applied. Chaining is retained; a fallback may be passed and will take effect.</UL>
<P>Prices may be adjusted in several ways, and the individual actions are referred to below as <I>atoms</I>.  Price atoms they may be <I>final</I>, <I>chained</I>, or <I>fallback</I>. A final price atom is always applied if it does not evaluate to zero. A chained price atom is subject to further adjustment. A fallback price atom is skipped if a previous chained price was not zero.</P>
<P>Atoms are separated by whitespace, and may be quoted (although there should not normally be whitespace in a setting). A chained item ends with a comma.  A fallback item has a leading semi-colon.  Final atoms have no comma appended or semi-colon prepended.</P>
<P>A <I>settor</I> is the means by which the price is set. There are eight different types of price settors. All settors can then yield another CommonAdjust string.</P>
<P>It is quite possible to create endless loops, so the maximum number of initial CommonAdjust strings is set to 16, and there may be only 20 iterations before the price will return zero on an error.</P>
<P><B>NOTE</B>:  Common needs are easily shown but not so easily explained; skip to the examples if the reference below if your vision starts to blur when reading the next section. 8-)</P>
<P>USAGE: Optional items below have asterisks appended. The asterisk should not be used in the actual string. Optional <B>base</B> or <B>table</B> always defaults to the active <TT>products</TT> database table.  The optional <B>key</B> defaults to the item code except in a special case for the attribute-based lookup. The <B>field</B> name is not optional except in the case of an attribute lookup.</P>
<P><B>N.NN or -N.NN</B></P>
<UL>
where N is a digit.  A number which is applied directly; for instance 10 will yield a price of 10. May be a positive or negative number.</UL>
<P><B>N.NN%</B></P>
<UL>
where N is a digit.  A number which is applied as a percentage of the <I>current</I> price value. May be a positive or negative number. For example, if the price is 10 and -8% is applied, the next price value will be 9.20.</UL>
<P><B>table*:column:key*</B></P>
<UL>
Causes a straight lookup in a database table. The optional <B>table</B> defaults to the main products database table for the item (subject of course to multiple product files). The <B>column</B> must always be present. The optional <B>key</B> defaults to the item code except in a special case for the attribute-based lookup. The return value is then re-parsed as another price settor.</UL>
<P><B>table*:col1..col5,col10:key*</B></P>
<UL>
Causes a quantity lookup in database table <B>table</B> (which defaults to the products database), with a set of comma-separated fields, looked up by the optional <B>key</B>. (Key defaults to the item code, of course). If ranges are specified with .., each column in the sequence will be used; Therefore</UL>
<PRE>
        pricing:p1,p2,p3,p4,p5,p10:
</PRE>
<UL>
is the same as</UL>
<PRE>
        pricing:p1..p5,p10:
</PRE>
<UL>
Leading non-digits are stripped, and the item quantity is compared with the numerical portion of the column name. The price is set to the value of the database column (numeric portion) that is at least equal to it but doesn't yet reach the next break.
<BR>
WARNING: If the field at the appropriate quantity level is blank, a zero cost will be returned from the atom. It is important to have all columns populated.</UL>
<P><B>==attribute:table*:column*:key*</B></P>
<UL>
Does an attribute-based adjustment. The attribute is looked up in the database <B>table</B>, with the optional <B>column</B> defaulting to the same name as the <I>value</I> of the <B>attribute</B>. If the column is not left blank, the <I>key</I> is set to the <I>value</I> of the <B>attribute</B> if blank.</UL>
<P><B>&amp; CODE</B></P>
<UL>
The leading <TT>&amp;</TT> sign is stripped and the code is passed to the equivalent of a <TT>[calc]</TT> tag. No Interchange tags can be used, but the &amp;tag_data routine is available, the current value of the price and quantity are available as <TT>$s</TT>, and the current item (code, quantity, price, and any attributes) are available as <TT>$item</TT>, all forced to the package Vend::Interpolate. That means that in a UserTag:</UL>
<PRE>
      $Vend::Interpolate::item          is the current item
      $Vend::Interpolate::item-&gt;{code}  gives key for current item
      $Vend::Interpolate::item-&gt;{size}  gives size for current item (if there)
      $Vend::Interpolate::item-&gt;{mv_ib} gives database ordered from
</PRE>
<P><B>[valid Interchange tags]</B></P>
<UL>
If the settor begins with a square bracket (<TT>[</TT>) or underscore, it is parsed for Interchange tags with variable substitution (but no Locale substitution). You may define a price in a <I>Variable</I> in this fashion. The string is re-submitted as an atom, so it may yield yet another settor.</UL>
<P><B>$</B></P>
<UL>
Tells Interchange to look in the <TT>mv_price</TT> attribute of the shopping cart, and apply that price as the final price, if it exists. The attribute must be a numerical value.</UL>
<P><B>&gt;&gt;word</B></P>
<UL>
Tells the routine to return <TT>word</TT> directly as the result. This is not useful in pricing, as it will evaluate to zero. But when CommonAdjust is used for shipping, it is a way of re-directing shipping modes.</UL>
<P><B>word</B></P>
<UL>
The value of <TT>word</TT>, which must not match any of the other settors, is available as a key for the next lookup (only). If the next settor is a database lookup, and it contains a dollar sign (<TT>$</TT>) the <TT>word</TT> will be substituted; i.e. <TT>table:column:$</TT> becomes <TT>table:column:word</TT>.</UL>
<P><B>( settor )</B></P>
<UL>
The value returned by <TT>settor</TT> will be used as a key for the next lookup, as above.</UL>
<H2><A NAME="CommonAdjust Examples">2.3. CommonAdjust Examples</A></H2>
<P>Most examples below use an outboard database table named <B>pricing</B>, but any valid table including the <B>products</B> table can be used. We will refer to this <B>pricing</B> table:</P>
<PRE>
  code    common  q1     q5     q10    XL    S      red
  99-102          10     9      8      1     -0.50  0.75
  00-343                               2
  red      0.75
</PRE>
<P>The simplest case is a straight lookup on an attribute; <I>size</I> in this case.</P>
<PRE>
  10.00, ==size:pricing
</PRE>
<P>With this value in the <TT>price</TT> field, a base price of 10.00 will be adjusted with the value of the <I>size</I> attribute. If size for the item 99-102 is set to <TT>XL</TT> then 1.00 will be added for a total price of 11.00; if it is <TT>S</TT> then .50 will be subtracted for a total price of 9.50; for any other value of <I>size</I> no further adjustment would be made. 00-343 would be adjusted up 2.00 only for <I>XL</I>.</P>
<PRE>
  10.00, ==size:pricing, ==color:pricing
</PRE>
<P>This is the same as above, except both size and color are adjusted for. A color value of red for item code 99-102 would add 0.75 to the price. For 00-343 it would have no effect.</P>
<PRE>
  10.00, ==size:pricing, ==color:pricing:common
</PRE>
<P>Here price is set based on a common column, keyed by the value of the color attribute. Any item with a color value of red would have 0.75 added to the base price.</P>
<PRE>
  pricing:q1,q5,q10:, ;10.00, ==size:pricing, ==color:pricing:common
</PRE>
<P>Here is a quantity price lookup, with a fallback price setting. If there is a valid price found at the quantity of 1, 5, or 10, depending on item quantity, then it will be used. The fallback of 10.00 only applies if no non-zero/non-blank price was found at the quantity lookup. In either case, size/color adjustment is applied.</P>
<PRE>
  pricing:q1,q5,q10:, ;10.00 ==size:pricing, ==color:pricing:common
</PRE>
<P>Removing the comma from the end of the fallback string stops color/size lookup if it reaches that point. If a quantity price was found, then size and color are chained.</P>
<PRE>
  pricing:q1,q5,q10:, ;products:list_price, ==size:pricing, ==color:pricing
</PRE>
<P>The value of the database column <TT>list_price</TT> is used as a fallback instead of the fixed 10.00 value. The above value might be a nice one to use as the default for a typical retail catalog that has items with colors and sizes.</P>
<H2><A NAME="PriceBreaks, discounts, and PriceAdjustment">2.4. PriceBreaks, discounts, and PriceAdjustment</A></H2>
<P>There are several ways that Interchange can modify the price of a product during normal catalog operation. Several of them require that the <I>pricing.asc</I> file be present, and that you define a pricing database. You do that by placing the following directive in <I>catalog.cfg</I>:</P>
<PRE>
  Database  pricing pricing.asc 1
</PRE>
<P>NOTE: PriceAdjustment is slightly deprecated by CommonAdjust, but will remain in use at least through the end of Version 3 of Interchange.</P>
<P>Configurable directives and tags with regard to pricing:</P>
<UL>
<LI>Quantity price breaks are configured by means of the <I>PriceBreaks</I> and <I>MixMatch</I> directives. They require a field named specifically <TT>price</TT> in the pricing database. The <B>price</B> field contains a space-separated list of prices that correspond to the quantity levels defined in the <TT>PriceBreaks</TT> directive. If quantity is to be applied to all items in the shopping cart (as opposed to quantity of just that item) then the <I>MixMatch</I> directive should be set to <B>Yes</B>.
<LI>Individual line-item prices can be adjusted according to the value of their attributes. See <I>PriceAdjustment</I> and <I>CommonAdjust</I>. The pricing database <B>must</B> be defined unless you define the <TT>CommonAdjust</TT> behavior.
<LI>Product discounts for individual products, specific product codes, all products, or the entire order can be configured with the <TT>[discount ...]</TT> tag. Discounts are applied on a per-user basis -- you can gate the discount based on membership in a club or other arbitrary means. See <I>Product Discounts</I>.</UL>
<P>For example, if you decided to adjust the price of T-shirt part number 99-102 up 1.00 when the size is extra large and down 1.00 when the size is small, you would have the following directives defined in &lt;catalog.cfg&gt;:</P>
<PRE>
  Database          pricing pricing.asc 1
  UseModifier       size
  PriceAdjustment   size
</PRE>
<P>To enable automatic modifier handling, you define a size field in products.txt:</P>
<PRE>
  code    description   price    size
  99-102  T-Shirt       10.00    S=Small, M=Medium, L=Large*, XL=Extra Large
</PRE>
<P>You would place the proper tag within your <TT>[item-list]</TT> on the shopping-basket or order page:</P>
<PRE>
    [item-accessories size]
</PRE>
<P>In the pricing.asc database source, you would need:</P>
<PRE>
  code      S       XL
  99-102    -1.00   1.00
</PRE>
<P>If you want to assign a price based on the option, precede the number with an equals sign:</P>
<PRE>
  code    S       M       L       XL
  99-102  =9.00   =10     =10     =11
</PRE>
<P>IMPORTANT NOTE: Price adjustments occur AFTER quantity price breaks, so the above would negate anything set with the <I>PriceBreaks</I> directive/option.</P>
<P>Numbers that begin with an equals sign (<TT>=</TT>) are used as absolute prices and are <I>interpolated for Interchange tags first</I>, so you can use subroutines to set the price. To facilitate coordination with the subroutine, the session variables <TT>item_code</TT> and <TT>item_quantity</TT> are set to the code and quantity of the item being evaluated. They would be accessed in a global subroutine with <TT>$Vend::Session-</TT>&gt;<TT>{item_code}</TT> and <TT>$Vend::Session-</TT>&gt;<TT>{item_quantity}</TT>.</P>
<P>The pricing information must always come from a database because of security.</P>
<H2><A NAME="Item Attributes">2.5. Item Attributes</A></H2>
<P>Interchange allows item attributes to be set for each ordered item. This allows a size, color, or other modifier to be attached to a common part number. If multiple attributes are set, then they should be separated by commas. Previous attribute values can be saved by means of a hidden field on a form, and multiple attributes for each item can be <I>stacked</I> on top of each other.</P>
<P>The configuration file directive <I>UseModifier</I> is used to set the name of the modifier or modifiers. For example</P>
<PRE>
    UseModifier        size,color
</PRE>
<P>will attach both a size and color attribute to each item code that is ordered.</P>
<P><B>IMPORTANT NOTE:</B> You may not use the following names for attributes:</P>
<PRE>
    item  group  quantity  code  mv_ib  mv_mi  mv_si
</PRE>
<P>You can also set it in scratch with the mv_UseModifier scratch variable -- <TT>[set mv_UseModifier]size color[/set]</TT> has the same effect as above. This allows multiple options to be set for products. Whichever one is in effect at order time will be used. Be careful, you cannot set it more than once on the same page. Setting the <TT>mv_separate_items</TT> or global directive <I>SeparateItems</I> places each ordered item on a separate line, simplifying attribute handling. The scratch setting for <TT>mv_separate_items</TT> has the same effect.</P>
<P>The modifier value is accessed in the <TT>[item-list]</TT> loop with the <TT>[item-modifier attribute]</TT> tag, and form input fields are placed with the <TT>[modifier-name attribute]</TT> tag. This is similar to the way that quantity is handled, except that attributes can be &quot;stacked&quot; by setting multiple values in an input form.</P>
<P>You cannot define a modifier name of <I>code</I> or <I>quantity</I>, as they are already used. You must be sure that no fields in your forms have digits appended to their names if the variable is the same name as the attribute name you select, as the <TT>[modifier-name size]</TT> variables will be placed in the user session as the form variables size0, size1, size2, etc.</P>
<P>You can use the <TT>[loop arg=&quot;item item item&quot;]</TT> list to reference multiple display or selection fields for modifiers, or you can use the built-in <TT>[PREFIX-accessories ...]</TT> tags available in most Interchange list operations. The modifier value can then be used to select data from an arbitrary database for attribute selection and display.</P>
<P>Below is a fragment from a shopping basket display form which shows a selectable size with &quot;sticky&quot; setting. Note that this would always be contained within the <TT>[item_list]</TT> <TT>[/item-list]</TT> pair.</P>
<PRE>
    &lt;SELECT NAME=&quot;[modifier-name size]&quot;&gt;
    &lt;OPTION  [selected [modifier-name size] S]&gt; S
    &lt;OPTION  [selected [modifier-name size] M]&gt; M
    &lt;OPTION  [selected [modifier-name size] L]&gt; L
    &lt;OPTION [selected [modifier-name size] XL]&gt; XL
    &lt;/SELECT&gt;
</PRE>
<P>It could just as easily be done with a radio button group combined with the <TT>[checked ...]</TT> tag.</P>
<P>Interchange will automatically generate the above select box when the <TT>[accessories &lt;code</TT> size]&gt; or <TT>[item-accessories size]</TT> tags are called. They have the syntax:</P>
<PRE>
   [item_accessories attribute*, type*, field*, database*, name*, outboard*]

   [accessories code attribute*, type*, field*, database*, name*, outboard*]
</PRE>
<P><B>code</B></P>
<UL>
Not needed for item-accessories, this is the product code of the item to reference.</UL>
<P><B>attribute</B></P>
<UL>
The item attribute as specified in the UseModifier configuration directive. Typical are <TT>size</TT> or <TT>color</TT>.</UL>
<P><B>type</B></P>
<UL>
The action to be taken. One of:</UL>
<PRE>
      select          Builds a dropdown &lt;SELECT&gt; menu for the attribute.
                      NOTE: This is the default.
    
      multiple        Builds a multiple dropdown &lt;SELECT&gt; menu for the
                      attribute.  The size is equal to the number of
                      option choices.
    
      display         Shows the label text for *only the selected option*.
    
      show            Shows the option choices (no labels) for the option.
    
      radio           Builds a radio box group for the item, with spaces
                      separating the elements.
    
      radio nbsp      Builds a radio box group for the item, with &amp;nbsp;
                      separating the elements.
    
      radio left n    Builds a radio box group for the item, inside a
                      table, with the checkbox on the left side. If &quot;n&quot;
                      is present and is a digit from 2 to 9, it will align
                      the options in that many columns.
    
      radio right n   Builds a radio box group for the item, inside a
                      table, with the checkbox on the right side. If &quot;n&quot;
                      is present and is a digit from 2 to 9, it will align
                      the options in that many columns.
    
      check           Builds a checkbox group for the item, with spaces
                      separating the elements.
    
      check nbsp      Builds a checkbox group for the item, with &amp;nbsp;
                      separating the elements.
    
      check left n    Builds a checkbox group for the item, inside a
                      table, with the checkbox on the left side. If &quot;n&quot;
                      is present and is a digit from 2 to 9, it will align
                      the options in that many columns.
    
      check right n   Builds a checkbox group for the item, inside a
                      table, with the checkbox on the right side. If &quot;n&quot;
                      is present and is a digit from 2 to 9, it will align
                      the options in that many columns.
</PRE>
<UL>
The default is 'select', which builds an HTML select form entry for the attribute.  Also recognized is 'multiple', which generates a multiple-selection drop down list, 'show', which shows the list of possible attributes, and 'display', which shows the label text for the selected option only.</UL>
<P><B>field</B></P>
<UL>
The database field name to be used to build the entry (usually a field in the products database).  Defaults to a field named the same as the attribute.</UL>
<P><B>database</B></P>
<UL>
The database to find <B>field</B> in, defaults to the first products file where the item code is found.</UL>
<P><B>name</B></P>
<UL>
Name of the form variable to use if a form is being built. Defaults to mv_order_<B>attribute</B> -- i.e.  if the attribute is <B>size</B>, the form variable will be named <B>mv_order_size</B>.</UL>
<P><B>outboard</B></P>
<UL>
If calling the item-accessories tag, and you wish to select from an outboard database, you can pass the key to use to find the accessory data.</UL>
<P>When called with an attribute, the database is consulted and looks for a comma-separated list of attribute options. They take the form:</P>
<PRE>
    name=Label Text, name=Label Text*
</PRE>
<P>The label text is optional -- if none is given, the <B>name</B> will be used.</P>
<P>If an asterisk is the last character of the label text, the item is the default selection. If no default is specified, the first will be the default. An example:</P>
<PRE>
    [item_accessories color]
</PRE>
<P>This will search the product database for a field named &quot;color&quot;. If an entry &quot;beige=Almond, gold=Harvest Gold, White*, green=Avocado&quot; is found, a select box like this will be built:</P>
<PRE>
    &lt;SELECT NAME=&quot;mv_order_color&quot;&gt;
    &lt;OPTION VALUE=&quot;beige&quot;&gt;Almond
    &lt;OPTION VALUE=&quot;gold&quot;&gt;Harvest Gold
    &lt;OPTION SELECTED&gt;White
    &lt;OPTION VALUE=&quot;green&quot;&gt;Avocado
    &lt;/SELECT&gt;
</PRE>
<P>In combination with the <TT>mv_order_item</TT> and <TT>mv_order_quantity</TT> variables this can be used to allow entry of an attribute at time of order.</P>
<P>If used in an item list, and the user has changed the value, the generated select box will automatically retain the current value the user has selected.</P>
<P>The value can then be displayed with <TT>[item-modifier size]</TT> on the order report, order receipt, or any other page containing an <TT>[item-list]</TT>.</P>
<H2><A NAME="Product Discounts">2.6. Product Discounts</A></H2>
<P>Product discounts can be set upon display of any page. The discounts apply only to the customer receiving them, and are of one of three types:</P>
<PRE>
    1. A discount for one particular item code (key is the item-code)
    2. A discount applying to all item codes (key is ALL_ITEMS)
    3. A discount for an individual line item (set the mv_discount attribute
       with embedded Perl)
    4. A discount applied after all items are totaled
       (key is ENTIRE_ORDER)
</PRE>
<P>The discounts are specified via a formula. The formula is scanned for the variables $q and $s, which are substituted for with the item <I>quantity</I> and <I>subtotal</I> respectively. The variable $s is saved between iterations, so the discounts are cumulative. In the case of the item and all items discount, the formula must evaluate to a new subtotal for all items <I>of that code</I> that are ordered. The discount for the entire order is applied to the entire order, and would normally be a monetary amount to subtract or a flat percentage discount.</P>
<P>Discounts are applied to the effective price of the product, including any quantity discounts or price adjustments.</P>
<P>To apply a straight 20% discount to all items:</P>
<PRE>
    [discount ALL_ITEMS] $s * .8 [/discount]
</PRE>
<P>or with named attributes:</P>
<PRE>
    [discount code=ALL_ITEMS] $s * .8 [/discount]
</PRE>
<P>To take 25% off of only item 00-342:</P>
<PRE>
    [discount 00-342] $s * .75 [/discount]
</PRE>
<P>To subtract $5.00 from the customer's order:</P>
<PRE>
    [discount ENTIRE_ORDER] $s - 5 [/discount]
</PRE>
<P>To reset a discount, set it to the empty string:</P>
<PRE>
    [discount ALL_ITEMS][/discount]
</PRE>
<P>Perl code can be used to apply the discounts, and variables are saved between items and are shared with the <TT>[calc]</TT> tag. This example gives 10% off if two items are ordered, with 5% more for each additional up to a maximum of 30% discount:</P>
<PRE>
    [calc]
        [item-list]
            $totalq{&quot;[item-code]&quot;} += [item-quantity];
        [/item-list]
            return '';
    [/calc]

    [item-list]
        [discount code=&quot;[item-code]&quot;]
            return ($s)       if $totalq{&quot;[item-code]&quot;} == 1;
            return ($s * .70) if $totalq{&quot;[item-code]&quot;} &gt; 6;
            return ($s * ( 1 - 0.05 * $totalq{&quot;[item-code]&quot;} ));
        [/discount]
    [/item-list]
</PRE>
<P>Here is an example of a special discount for item code 00-343 which prices the <I>second</I> one ordered at 1 cent:</P>
<PRE>
    [discount 00-343]
    return $s if $q == 1;
    my $p = $s/$q;
    my $t = ($q - 1) * $p;
    $t .= 0.01;
    return $t;
    [/discount]
</PRE>
<P>If you want to display the discount amount, use the <TT>[item-discount]</TT> tag.</P>
<PRE>
    [item-list]
    Discount for [item-code]: [item-discount]
    [/item-list]
</PRE>
<P>Finally, if you want to display the discounted subtotal, you need to use the <TT>[calc]</TT> capability:</P>
<PRE>
    [item-list]
    Discounted subtotal for [item-code]: [currency][calc]
                                            [item-price] * [item-quantity]
                                            [/calc][/currency]
    [/item-list]
</PRE>
<HR>
<H1><A NAME="Taxing">3. Taxing</A></H1>
<P>Interchange allows taxing in a number of ways.</P>
<UL>
Simple salestax.asc table</UL>
<P>The <A HREF="icconfig.html#SalesTax">SalesTax</A> directive is set to a form field or fields for user input, and those form fields look up the tax rate in salestax.asc.</P>
<UL>
Fly tax</UL>
<P>Another simple tax method. A series of Interchange Variable settings are read to develop a salestax rate for one or a few localities, usually a state in the US.</P>
<UL>
Salestax multi -- VAT taxing</UL>
<P>The <A HREF="icfoundation.html#country">country</A> and <A HREF="icfoundation.html#state">state</A> tables are used to develop complex VAT or salestax rate calculations based on country and state, possibly with different rates based on product type.</P>
<UL>
Levies -- multiple levels of tax</UL>
<P>Using the <A HREF="icconfig.html#Levies">Levies</A> setting and the <A HREF="icconfig.html#Levy">Levy</A> structure, any or all of the above methods is used to implement one or more taxes.</P>
<H2><A NAME="Sales Tax -- simple salestax.asc table">3.1. Sales Tax -- simple salestax.asc table</A></H2>
<P>Interchange allows calculation of sales tax on a straight percentage basis, with certain items allowed to be tax-exempt. To enable this feature, the directive <I>SalesTax</I> is initialized with the name of a field (or fields) on the order form. Commonly, this is zipcode and/or state:</P>
<PRE>
    SalesTax    zip,state
</PRE>
<P>This being done, Interchange assumes the presence of a file <TT>salestax.asc</TT>, which contains a database with the percentages. Each line of <TT>salestax.asc</TT> should be a code (again, usually a five-digit zip or a two letter state) followed by a tab, then a percentage. Example:</P>
<PRE>
        DEFAULT 0.0
    45056   .0525
    61821   .0725
    61801   .075
    IL      .0625
    OH      .0525
    VAT     .15
    WA      .08
</PRE>
<P>Based on the user's entry of information in the order form, Interchange will look up (for our example SalesTax directive) first the zip, then the state, and apply the percentage to the SUBTOTAL of the order. The subtotal will include any taxable items, and will also include the shipping cost if the state/zip is included in the <I>TaxShipping</I> directive. It will add the percentage, then make that available with the <TT>[salestax]</TT> tag for display on the order form. If no match is found, the entry <TT>DEFAULT</TT> is applied -- it is normally zero.</P>
<P>If business is being done on a national basis, it is now common to have to collect sales tax for multiple states. If you are doing so, it is possible to subscribe to a service which issues regular updates of the sales tax percentages -- usually by quarterly or monthly subscription. Such a database should be easily converted to Interchange format -- but some systems are rather convoluted, and it will be well to check and see if the program can export to a flat ASCII file format based on zip code.</P>
<P>If some items are not taxable, then you must set up a field in your database which indicates that. You then place the <B>name</B> of that field in the <I>NonTaxableField</I> directive. If the field for that item evaluates true on a yes-no basis (i.e. is set to <TT>yes</TT>, <TT>y</TT>, 1, or the like), sales tax will not be applied to the item. If it evaluates false, it will be taxed.</P>
<P>If your state taxes shipping, use the <I>TaxShipping</I> directive. Utah and Nevada are known to tax shipping -- there may be others.</P>
<P>If you want to set a fixed tax for all orders, as might occur for VAT in some countries, just set the <I>SalesTax</I> directive to a value like <TT>tax_code</TT>, and define a variable in the user session to reflect the proper entry in the <TT>salestax.asc</TT> file.  To set it to 15% with the above <TT>salestax.asc</TT> file, you would put in a form:</P>
<PRE>
    &lt;INPUT TYPE=hidden NAME=tax_code VALUE=&quot;VAT&quot;&gt;
</PRE>
<P>or to do it without submitting a form:</P>
<PRE>
    [perl] $Values-&gt;{tax_code} = 'VAT'; return; [/perl]
</PRE>
<H2><A NAME="Fly tax">3.2. Fly tax</A></H2>
<P>The <A HREF="ictags.html#fly-tax">[fly-tax]</A> tag is placed in the DEFAULT setting of salestax.asc, and the variables <TT>TAXAREA</TT>, <TT>TAXRATE</TT>, and <TT>TAXSHIPPING</TT> are used to build the rates.</P>
<UL>
TAXAREA</UL>
<P>A space-separated or comma-seperated list of states to apply tax to. Not needed for anything in the calculation, it is used to build the UI list of states to tax.</P>
<UL>
TAXRATE</UL>
<P>An Interchange accessory-list style of value, with the format</P>
<PRE>
  XX=N.NN, XX=N.NN
</PRE>
<P>where XX is the two-letter state code and N.NN is the tax rate in percent. To apply a tax of 7.25% for Illinois and 5.5% for Nevada, you would use:</P>
<P>IL=7.25, NV=5.5</P>
<UL>
TAXSHIPPING</UL>
<P>A space- or comma-separated list of states where shipping is taxed. For the above example, if Nevada taxed shipping and Illinois did not, you would make TAXSHIPPING equal to &quot;NV&quot;.</P>
<UL>
The Salestax Directive</UL>
<P>To set the field that is used for the state code, you use the standard Interchange <A HREF="icconfig.html#SalesTax">SalesTax</A> directive. It would almost always be set to <TT>state</TT>.</P>
<H2><A NAME="Salestax &quot;multi&quot; -- VAT taxing">3.3. Salestax &quot;multi&quot; -- VAT taxing</A></H2>
<P>If the SalesTax directive is set to &quot;multi&quot;, then the type of tax is read from the country table (or the value that Variable MV_COUNTRY_TABLE is set to be). To see the tax type in force for the UK, you can place in a page:</P>
<PRE>
        [data table=country col=tax key=&quot;UK&quot;].
</PRE>
<P>Most everything is configurable for variable name and field name via different Variable settings. They are:</P>
<PRE>
  MV_COUNTRY_TABLE      Table for country info (default &quot;country&quot;)
  MV_COUNTRY_FIELD      Form field determining country (default &quot;country&quot;)
  MV_COUNTRY_TAX_FIELD  Table column for country-wide tax (default &quot;tax&quot;)
  MV_STATE_TABLE        Table for state/province info (default &quot;state&quot;)
  MV_STATE_FIELD        Form field determining state/province (default &quot;state&quot;)
  MV_STATE_TAX_FIELD    Table column for state-wide tax (default &quot;tax&quot;)
  MV_TAX_TYPE_FIELD     Table column enumerating tax types (default &quot;tax_type&quot;)
  MV_TAX_CATEGORY_FIELD Table column for product type (default tax_category)
</PRE>
<P>Below, we refer to the tables, columns, and fields by their default names.</P>
<P>The first lookup is done in table <TT>country</TT> based on the user input of <TT>country</TT> (i.e. <TT>[value country]</TT>). The <TT>tax</TT> field is read and one of the following is done:</P>
<P>1. If no string is found, tax returns 0.</P>
<P>2. If string &quot;simple:XX&quot; is found, uses [fly-tax] with the area specifed in XX.</P>
<P>3. If string &quot;state&quot; is found, does a re-lookup with</P>
<PRE>
     select tax from state where country = country and state = state
</PRE>
<P>and value is applied as below.</P>
<P>4. If just digits are found, rate applied directly -- i.e. &quot;0.05&quot;</P>
<P>5. If N.NN% is found, applied as percentage.</P>
<P>6. If <TT>category = N.NN%, default = N.NN%</TT> is found, the <TT>tax_category</TT> field in the <A HREF="icfoundation.html#products">products</A> table is used to determine tax basis. If no tax_category is found for the product, <TT>default</TT> rate is used.</P>
<P>This product data</P>
<PRE>
    sku      price     tax_category
    os28003  10.00     tools
    os28004  20.00     food
</PRE>
<P>with this country and state data:</P>
<PRE>
    code     name     tax
    US       U.S.A.   state
    JP       Japan    tools=10%, default=15%


    code   country   state   name      tax
    0001   US        IL      Illinois  6.5%
    0002   US        OH      Ohio      default = 5.5%, food = 1%
    0003   US        AZ      Arizona
</PRE>
<P>Will yield tax for one each of os28003 and os28004 of:</P>
<PRE>
    Japan   $4.00
    US/IL   $1.95
    US/OH   $0.75
    US/AZ   $0.00
</PRE>
<HR>
<H1><A NAME="THE CHECKOUT PROCESS">4. THE CHECKOUT PROCESS</A></H1>
<H2><A NAME="Advanced Multi-level Order Pages">4.1. Advanced Multi-level Order Pages</A></H2>
<P>An unlimited number of order checking profiles can be defined with the <I>OrderProfile</I> directive, or by defining order profiles in scratch variables. This allows a multi-level ordering process, with checking for format and validity at every stage.</P>
<P>To custom-configure the error message, place it after the format check requirement.</P>
<P>Specifications take the form of an order page variable (like name or address), followed by an equals sign and one of five check types:</P>
<P><B>required</B></P>
<UL>
A non-blank value is required</UL>
<P><B>mandatory</B></P>
<UL>
Must be non-blank, and must have been specified on this form, not a saved value from a previous form</UL>
<P><B>phone</B></P>
<UL>
The field must look like a phone number, by a very loose specification allowing numbers from all countries</UL>
<P><B>phone_us</B></P>
<UL>
Must have US phone number formatting, with area code</UL>
<P><B>state</B></P>
<UL>
Must be a US state, including DC and Puerto Rico.</UL>
<P><B>province</B></P>
<UL>
Must be a Canadian province or pre-1997 territory.</UL>
<P><B>state_province</B></P>
<UL>
Must be a US state or Canadian province.</UL>
<P><B>zip</B></P>
<UL>
Must have US postal code formatting, with optional ZIP+4. Also called by the alias <TT>us_postcode</TT>.</UL>
<P><B>ca_postcode</B></P>
<UL>
Must have Canadian postal code formatting. Checks for a valid first letter.</UL>
<P><B>postcode</B></P>
<UL>
Must have Canadian or US postal code formatting.</UL>
<P><B>true</B></P>
<UL>
Field begins with <B>y</B>, <B>1</B>, or <B>t</B> (Yes, 1, or True) - not case sensitive</UL>
<P><B>false</B></P>
<UL>
Field begins with <B>n</B>, <B>0</B>, or <B>f</B> (No, 0, or False) - not case sensitive</UL>
<P><B>email</B></P>
<UL>
Rudimentary email address check, must have an '@' sign, a name, and a minimal domain</UL>
<P><B>regex</B></P>
<UL>
A regular expression to check against. To check that all submissions of the &quot;foo&quot; variable have &quot;bar&quot; at the beginning, do:</UL>
<PRE>
            foo=regex ^bar
</PRE>
<UL>
You can add an error message by putting it in quotes at the end:</UL>
<PRE>
       foo=regex ^bar &quot;You must have bar at the beginning of this&quot;
</PRE>
<UL>
If you want to use a backslash to introduce a Perl literal like <TT>\w</TT>, you must double the backslash, i.e.</UL>
<PRE>
            foo=regex ^bar\\w+$ &quot;You must have 'bar' followed by only word characters&quot;
</PRE>
<P><B>length</B></P>
<UL>
A range of lengths you want the input to be:</UL>
<PRE>
       foo=length 4-10
</PRE>
<UL>
That will require <TT>foo</TT> be from 4 to 10 characters long.</UL>
<P><B>unique</B></P>
<UL>
Tests to see that the value would be a unique key in a table:</UL>
<PRE>
       foo=unique userdb Sorry, that username is already taken
</PRE>
<P><B>filter</B></P>
<UL>
Runs the value through an Interchange filter and checks that the returned value is equal to the original value.</UL>
<PRE>
       foo=filter entities Sorry, no HTML allowed
</PRE>
<UL>
To check for all lower-case characters:</UL>
<PRE>
            foo=filter lower Sorry, no uppercase characters
</PRE>
<P>Also, there are pragmas that can be used to change behavior:</P>
<P><B>&amp;charge</B></P>
<UL>
Perform a real-time charge operation. If set to any value but &quot;custom&quot;, it will use Interchange's CyberCash routines. To set to something else, use the value &quot;custom ROUTINE&quot;. The ROUTINE should be a GlobalSub which will cause the charge operation to occur -- if it returns non-blank, non-zero the profile will have succeeded. If it returns 0 or undef or blank, the profile will return failure.</UL>
<P><B>&amp;credit_card</B></P>
<UL>
Checks the mv_credit_card_* variables for validity. If set to &quot;standard&quot;, it will use Interchange's <TT>encrypt_standard_cc</TT> routines. This destroys the CGI value of mv_credit_card_number -- if you don't want that to happen (perhaps to save it for sending to CyberCash) then add the word <TT>keep</TT> on the end.
<BR>
Example:</UL>
<PRE>
        # Checks credit card number and destroys number after encryption
        # The charge operation can never work
    
        &amp;credit_card=standard
        &amp;charge=custom authorizenet
    
        # Checks credit card number and keeps number after encryption
        # The charge operation can now work
    
        &amp;credit_card=standard keep
        &amp;charge=custom authorizenet
</PRE>
<UL>
You can supply your own check routine with a GlobalSub:</UL>
<PRE>
        &amp;credit_card=check_cc
</PRE>
<UL>
The <TT>GlobalSub</TT> check_cc will be used to check and encrypt the credit card number, and its return value will be used to determine profile success.</UL>
<P><B><TT>&amp;</TT>fail</B></P>
<UL>
Sets the mv_failpage value.</UL>
<PRE>
        &amp;fail=page4
</PRE>
<UL>
If the submit process succeeds, the user will be sent to the page <TT>page4</TT>.</UL>
<P><B><TT>&amp;</TT>fatal</B></P>
<UL>
Set to '&amp;fatal=yes' if an error should generate the error page.</UL>
<P><B><TT>&amp;</TT>final</B></P>
<UL>
Set to '&amp;final=yes' if a successful check should cause the order to be placed.</UL>
<P><B><TT>&amp;</TT>update</B></P>
<UL>
Set to '&amp;update=yes' if a successful check should cause the variable to be copied from the CGI space to the Values space. This is like [update values] except only for that variable.
<BR>
This is typically used when using a <TT>mv_form_profile</TT> check so that a failing check will not cause all values to be reset to their former state upon returning to the form.</UL>
<P><B><TT>&amp;</TT>return</B></P>
<UL>
Causes profile processing to terminate with either a success or failure depending on what follows. If it is non-blank and non-zero, the profile succeeds.</UL>
<PRE>
        # Success :)
        &amp;return 1
    
        # Failure :\
        &amp;return 0
</PRE>
<UL>
Will ignore the &amp;fatal pragma, but &amp;final is still in effect if set.</UL>
<P><B><TT>&amp;</TT>set</B></P>
<UL>
Set a user session variable to a value, i.e. <TT>&amp;set=mv_email [value email]</TT>. This will not cause failure if blank or zero.</UL>
<P><B><TT>&amp;</TT>setcheck</B></P>
<UL>
Set a user session variable to a value, i.e. <TT>&amp;set=mv_email [value email]</TT>.  This <B>will</B> cause failure if set to a blank or zero. It is usually placed at the end after a &amp;fatal pragma would have caused the process to stop if there was an error -- can also be used to determine pass/fail based on a derived value, as it will cause failure if it evaluates to zero or a blank value.</UL>
<P><B><TT>&amp;</TT>success</B></P>
<UL>
Sets the mv_successpage value. Example:</UL>
<PRE>
        &amp;success=page5
</PRE>
<UL>
If the submit process succeeds, the user will be sent to the page <TT>page5</TT>.</UL>
<P>As an added measure of control, the specification is evaluated for the special Interchange tags to provide conditional setting of order parameters. With the <TT>[perl]</TT> <TT>[/perl]</TT> capability, quite complex checks can be done. Also, the name of the page to be displayed on an error can be set in the <TT>mv_failpage</TT> variable.</P>
<P>The following file specifies a simple check of formatted parameters:</P>
<PRE>
 name=required You must give us your name.
 address=required Oops! No address.
 city=required
 state=required
 zip=required
 email=required
 phone_day=phone_us XXX-XXX-XXXX phone-number for US or Canada
 &amp;fatal=yes
 email=email Email address missing the domain?
 &amp;set=mv_email [value email]
 &amp;set=mv_successpage ord/shipping
</PRE>
<P>The profile above only performs the &amp;set directives if all of the previous checks have passed -- the &amp;fatal=yes will stop processing after the check of the email address if any of the previous checks failed.</P>
<P>If you want to place multiple order profiles in the same file, separate them with __END__, which must be on a line by itself.</P>
<P>User-defined check routines can be defined in a GlobalSub:</P>
<PRE>
    GlobalSub &lt;&lt;EOF
    sub set_up_extra_check {
        BEGIN {
            package Vend::Order;
            sub _pt_postcode {
                # $ref is to Vend::Session-&gt;{'values'} hash
                # $var is the passed name of the variable
                # $val is current value of checked variable
                my($ref, $var, $val) = @_;

                if ($ref-&gt;{country} =~ /^(PT|portugal)$/i) {
                    return $val =~ /^\d\d\d\d$/ ?
                        (1, $var, '') : (undef, $var, &quot;not a Portugese postal code&quot;);
                }
                else {
                    return (1, $var, '');
                }
            }
        }
    }
    EOF
</PRE>
<P>Now you can specify in an order profile:</P>
<PRE>
  postcode=pt_postcode
</PRE>
<P>Very elaborate checks are possible. There must be an underscore preceding the routine name. The return value of the subroutine should be a three-element array, consisting of:</P>
<OL>
<LI>the pass/fail ('1' or 'undef') status of the check;
<LI>the name of the variable which was checked;
<LI>a standard error message for the failure, in case a custom one has not been specified in the order profile.</OL>
<P>The latter two elements are used by the <TT>[error]</TT> tag for on-screen display of form errors. The checkout page of the Foundation demo includes examples of this.</P>
<H2><A NAME="Simple Order Report File">4.2. Simple Order Report File</A></H2>
<P>The simple order report file, &quot;report&quot;, defines the layout of the order report which gets mailed on the completion of the order. For example,</P>
<PRE>
              Order Date: $date

                    Name: $name
           Email address: $email

        Shipping address: $addr
        Town, State, Zip: $town, $state $zip
                 Country: $country
</PRE>
<P>Any input field from the order page can be included using the dollar sign notation.</P>
<P>Interchange defines some values for use in the search form -- they begin with <TT>mv_</TT> and are automatically ignored.</P>
<H2><A NAME="Fully-configurable Order Reports">4.3. Fully-configurable Order Reports</A></H2>
<P>You can specify a fully-configurable order report by setting the hidden field &quot;mv_order_report&quot; to a legal Interchange page. This page will be interpolated with all Interchange tags before sending by email. The order number as set by backend ordering is in the variable mv_order_number, and available for your use.</P>
<P>You could if you wish include HTML in the file, which will be interpreted by many mailers, but you can choose to use standard ASCII format. An example report is provided in the demo file &lt;pages/ord/report.html&gt;.</P>
<H2><A NAME="Order Receipts">4.4. Order Receipts</A></H2>
<P>The file can of course be configured with all Interchange tags, and will be interpolated for the ordered items before they are deleted from the user session. You can set the default receipt with the <TT>receipt</TT> key in SpecialPage. If using order <I>Route</I>s, as in the <TT>foundation</TT> demo, you set it with the <TT>receipt</TT> key to <TT>Route</TT>.</P>
<H2><A NAME="The Order Counter">4.5. The Order Counter</A></H2>
<P>An order counter can be enabled if the <I>OrderCounter</I> directive is set to a file name. An incrementing count of all orders will be kept and assigned as orders are placed. By default, the number starts at 0, but you can edit the file and change the default starting number at any time.</P>
<P>This capability is made possible by the File::CounterFile module, available (as a part of the fine libwww modules) at the same place you got Interchange. It is included with the distribution.</P>
<H2><A NAME="Customer Input Fields">4.6. Customer Input Fields</A></H2>
<P>On the order (or shopping basket) page, by default order.html, you will have a number of input fields allowing the customer to enter information such as their name and address. You can add more fields simply by putting more input elements on the order.html page, and the information will automatically be included in the order report. Input elements should be written in this way:</P>
<PRE>
    &lt;input type=&quot;text&quot; name=&quot;town&quot; value=&quot;[value town]&quot; size=30&gt;
</PRE>
<P>Choose a name for this input field such as &quot;email&quot; for an email address. Set the name attribute to the name you have chosen.</P>
<P>The value attribute specifies the default value to give the field when the page is displayed. Because the customer may enter information on the order page, return to browsing, and come back to the order page, you want the default value to be what was entered the first time. This is done with the <TT>[value var]</TT> element, which returns the last value of an input field. Thus,</P>
<PRE>
    value=&quot;[value name]&quot;
</PRE>
<P>will evaluate to the name entered on the previous order screen, such as:</P>
<PRE>
       value=&quot;Jane Smith&quot;
</PRE>
<P>which will be displayed by the browser.</P>
<P>The size attributes specifies how many characters wide the input field should be on the browser. You do not need to set this to fit the longest possible value since the browser will scroll the field, but you should set it large enough to be comfortable for the customer.</P>
<HR>
<P>Copyright 2001-2002 Red Hat, Inc. Freely redistributable under terms of the GNU General Public License.</P>
</DIV>
<DIV CLASS="footer">
<DIV CLASS="navigate">
<P ALIGN="Center"><A HREF="index.html" TARGET="_top">Documentation Index</A></P>
</DIV>
<HR>
<ADDRESS><SPAN CLASS="doc-id">ic_ecommerce-1.16</SPAN> <SPAN CLASS="doc-status">(Draft)</SPAN></ADDRESS>
<ADDRESS CLASS="doc-modified">12 August 2002</ADDRESS>
<ADDRESS CLASS="copyright">Copyright &copy;  1996-2001 Red Hat, Inc. &lt;<A HREF="mailto:interchange@redhat.com">interchange@redhat.com</A>&gt;</ADDRESS>
</DIV>

</BODY>
</HTML>
